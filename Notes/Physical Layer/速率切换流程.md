# 速率切换流程

## 在不做EQ的情况下切换速率

1. 首先，speed change只能由Upstream Port发起，发起的原因是USP内部的directed speed change flag标志位在先前因为一些原因被set了
2. EP device中的directed speed change bit因为软件或者硬件原因设置为1。Upstream Port发起切速率。Upstream Port进入Recovery.RcvrLock，并且发送TS1 OS，其中speed_change bit为1，并且列出自己支持的所有speed。如果想要切换到8.0 GT/s，则发送的是EQ TS1 OS，而非普通TS1 OS
3. Downstream Port接收到Upstream Port发来的TS1 OS了，在接收到的时候就进入Recovery.RcvrLock了。当接收到8个连续的TS1 OS，且speed_change为1b时，它将自己内部的directed speed change flag设置为1，也开始发送TS1 OS，其中speed_change为1b。link使用的速率为双方支持的最大速率。
4. Upstream Port接收到Device B发来的8个连续的TS1 OS，且speed_change为1b，则Upstream Port进入Recovery.RcvrConfig，开始发送TS2 OS，且speed change bit为1，如果不是因为可靠性原因切速率的话，将Autonomous Change bit也设置为1b
5. Downstream Port接收到TS2 OS，它也进入Recovery.RcvrCfg，并且开始发送TS2 OS。但是注意，对于Downstream Port而言，它发送的TS中的Autonomous Change bit始终为rsvd
6. 当Upstream Port和Downstream Port都看到8个TS 2 os之后，进入Recovery.Speed。注意在进入Recovery.Speed时，Downstream Port需要将收到的TS OS中的Autonomous Change bit存到自己的register中。
7. 此时Upstream Port和 Downstream Port都处于Recovery.Speed，他们的Tx处于Electrical Idle，而后将速率切换到双方支持的最大速率。最后Upstream Port将内部的directed_speed_change设为0b
8. 在Recovery.Speed timeout之后，两个Device都进入Recovery.RcvrLock，使用新速率来Lock。即两边互发TS1 OS，注意此时speed_change为0b。如果正常工作，则进入Recovery.RcvrCfg，开始互相发送TS2 OS，但注意speed_change为0b。而后双方Recovery.Idle，最后进入L0正常工作。注意如果需要进行EQ的话，则在Recovery.RcvrLock之后，进入的是Recovery.Equalization来进行EQ
9. 在step 8，两个device都进入Recovery.RcvrLock，但是如果 Downstream Port有问题，不能获得Bit Lock，则 Downstream Port在Recovery.RcvrLock timeout之后进入Recovery.Speed。此时Upstream Port可能已经进入Recovery.RcvrCfg了，但是看到Downstream Port处于EI了，则Upstream Port也进入Recovery.Speed。而后双方退回刚进入Recovery时的速率。这个是怎么判断的呢？