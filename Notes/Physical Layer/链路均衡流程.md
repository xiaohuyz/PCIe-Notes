# 链路均衡流程

## 2.5 GT/s和5.0 GT/s到8.0 GT/s的链路均衡流程

2.5 GT/s和5.0 GT/s到8.0 GT/s的链路均衡

1. USP发起链路均衡，USP进入Recovery.RcvrLock，开始发送TS1 OS
2. DSP收到TS1 OS之后，也进入Recovery.RcvrLock，开始发送TS1 OS
3. USP收到TS1 OS，进入Recovery.RcvrCfg，开始发送TS2 OS
4. DSP收到TS2 OS之后，进入Recover.RcvrCfg，开始发送EQ TS2 OS，我们说此时DSP处于EQ Phase 0。注意此时的EQ TS2 OS中带有DSP register中存储的Upstream Port 8.0 GT/s Transmitter Preset和Upstream Port 8.0 GT/s Receiver Preset Hint的值
5. DSP和USP互传TS2 OS之后，进入Recovery.Speed切速率，而后同样返回Recovery.RcvrLock
6. 两边互传TS1 OS之后，DSP进入Recovery.Equal，我们说此时DSP处于EQ Phase 1，它发送TS1 OS，且EC=01b，它带有的Tx Preset和Rx Preset Hint和发送EQ TS2时的一样，都是用的自己register中的值
7. 两边互传TS1 OS之后，USP也进入Recovery.Equal，我们说此时USP处于EQ Phase 0，它也发送TS1 OS，但EC=00b。注意USP此时发送TS1 OS时使用的Tx参数是前文EQ TS2 OS中的参数，且返回的TS1 OS中的对应参数也是如此
8. 同时USP也在评估DSP发送的信号质量，如果质量足够好，则USP进入EQ Phase1，它也发送TS1 OS，EC=01b回去了。
9. DSP接收到2个EC=01b的TS，证明USP的Tx质量足够好，则进入EQ Phase 2了，开始发送TS1 OS，EC=10b。
10. USP接收到TS1 OS，EC=10b之后，也进入EQ Phase2，返回TS1 OS，EC=10b。两边都进入EQ Phase 2表明两边Tx发送的数据最起码能满足接收方BER小于10^-4
11. USP不断调整自己发送的TS1 OS，EC=10b的参数值，并且评估DSP返回来的TS1 OS，EC=10b的质量，当合格时，USP进入EQ Phase3，开始发送TS1 OS，EC=11b
12. DSP接收到TS1 OS，EC=11b，则进入EQ Phase 3，开始发送TS1 OS，EC=11b，并且不断调整参数值，评估USP返回来的TS1 OS，EC=11b。当评估合格，DSP发送TS1 OS，EC=00b
13. USP接收到TS1 OS，EC=00b，则发送TS1 OS，EC=00b，两者退出Recovery.Equal，进入Recovery.RcvrLock。均衡过程结束。
14. Tips：我们在step中看到，在常规的链路训练流程中，我们只用到了EQ TS2 OS，其余的都是常规的TS OS。注意EQ TS1 OS不用于常规链路均衡流程，而是用于redo equlization
15. 在step 5之后，互传的都是常规TS，原来用来放Tx Preset和Rx Hint的field现在用来放EC了，而详细的链路训练参数是通过设置其他field来设置的

2.5 GT/s或者5.0 GT/s到32.0 GT/s的链路均衡，和到8.0 GT/s的情况一样，只是提前advertise了支持bypass to highest NRZ

8.0 GT/s到16.0 GT/s的均衡，以及16.0 GT/s到32.0 GT/s的均衡，主要就是DSP在Recovery.RcvrCfg state中，发送的TS2 OS变成了128b/130b EQ TS2 OS

1. USP进入Recovery.RcvrLock，发送TS1 OS
2. DSP接收到TS1 OS，进入Recovery.RcvrLock，发送TS1 OS
3. USP接收到返回的TS1 OS，进入Recovery.RcvrCfg，发送TS2 OS，注意前三步中发送的TS OS都是普通TS而非EQ TS
4. 对于Downstream Port，它接收到USP发来的TS2 OS，进入Recovery.RcvrCfg。在Recovery.RcvrCfg state中，它发送EQ TS2 OS，且带有Tx Presets和Rx Hints。此时我们就说Downstream Port实际上处于EQ的Phase 0 state。其实就是，对于Downstream Port，EQ的Phase 0 state是在speed切换之前的。其实这个所谓的DSP的phase 0，和常规速率切换相比，就是把在Recovery.RcvrCfg state中发送的TS2 OS换成了EQ TS2 OS，而与Recovery.Equalization state无关
5. 而后，经过双方TS2 OS的互传，Downstream Port从Recovery.RcvrCfg进入Recovery.Speed，而后进入Recovery.RcvrLock来获得Lock。其实就是从这一步开始与无需EQ的升速率流程不同，多了从Recovery.RcvrLock进入Recovery.Equal，而后再返回的过程。DSP进入Recovery.Equal，此时我们说Downstream Port处于EQ的Phase 1 state。 它开始发送TS1s，且EC=01b
6. 注意，在NRZ的速率切换与链路均衡流程中，一般只有Recovery.RcvrLock和Recovery.Equalization的互转。而Recovery.Equalizaiton到Recovery.Speed的情形，一是用于loopback，二是用于在NRZ下完成链路均衡后，还需要在PAM4下完成64GT/s的链路均衡。
7. 对于Upstream Port，它在Downstream进入Recovery.Lock发送TS1 OS之后，接收到TS1 OS，则进入Recovery.Lock，接收到8个TS1 OS之后进入Recovery.Speed，而后进入Recovery.RcvrLock来获得Lock。而后进入Recovery.Equal，此时我们说Upstream Port处于EQ的Phase  0 state。注意此时USP的Tx侧使用的就是在EQ TS 2中获得的参数。此时USP发送的  EQ TS1s中，EC=00b，而Tx Presets和Rx Hints其实就是在Step 1中DSP发的值。其实就是，这些Tx Presets和Rx Hints并不是USP来配置DSP的tx用的，而是简单的echo back
8. 对于USP而言，它一方面在发EQ TS1回去，另一方面在评估DSP发来的TS的质量，当接收到2个TS1 OS之后，说明信号BER小于10^-4，则USP开始发送EQ TS1 OS回去，但是EC=01b，即USP也进入Phase1了
9. 对于DSP，它评估USP发来的TS的质量，当接收到2个TS1 OS之后，说明信号BER小于10^-4。当DSP认为信号质量足够好，则开始发送TS1 OS，其中EC=10b，进入phase2。USP也觉得质量足够好，则返回TS1 OS，其中EC=10b，USP也进入Phase2。而后如果DSP认为链路足够稳定了，则发送TS1 OS，其中EC=00b，来退出EQ流程
10. DSP和USP都在Phase 2了，但USP在Phase 2中并没有觉得信号足够好，则它返回的EQ TS1 OS中EC=10b，并且尝试发送不同的参数来设置DSP的Tx，并且评估质量，当USP觉得质量足够，则它发送EQ TS1 OS，且EC=11b，进入phase 3
11. DSP进入phase3，发送EQ TS1 OS，且EC=11b，做同样的评估。当它觉得信号质量足够，则发送TS 1 OS，EC=00b，USP返回同样的TS1 OS，两者退出EQ
12. 两者进入Recovery.Lock，而后进入Recovery.RcvrCfg，而后进入Recovery.Idle之后进入L0